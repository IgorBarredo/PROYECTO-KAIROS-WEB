{% extends 'base.html' %}
{% load static %}

{% block title %}Change Password - Proyecto Kairos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auth2fa.css' %}">
{% endblock %}

{% block content %}

<div class="auth-container">
  <div class="auth-box password-box">
    
    <div class="back-link">
      <a href="{% url 'appKairos:perfil' %}">‚Üê Back to Profile</a>
    </div>

    <div class="icon-password">üîë</div>
    
    <h1>Change Password</h1>
    <p class="subtitle">Update your account password</p>
    
    <form method="POST" class="auth-form" id="passwordForm">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="password_actual">Current Password</label>
        <div class="password-input-wrapper">
          <input 
            type="password" 
            id="password_actual" 
            name="password_actual"
            placeholder="Enter current password"
            required
          >
          <button type="button" class="toggle-password" onclick="togglePassword('password_actual')">
            üëÅÔ∏è
          </button>
        </div>
        {% if form.password_actual.errors %}
          <span class="error-message">{{ form.password_actual.errors.0 }}</span>
        {% endif %}
      </div>
      
      <div class="form-group">
        <label for="password_nueva">New Password</label>
        <div class="password-input-wrapper">
          <input 
            type="password" 
            id="password_nueva" 
            name="password_nueva"
            placeholder="Enter new password"
            required
            minlength="8"
          >
          <button type="button" class="toggle-password" onclick="togglePassword('password_nueva')">
            üëÅÔ∏è
          </button>
        </div>
        {% if form.password_nueva.errors %}
          <span class="error-message">{{ form.password_nueva.errors.0 }}</span>
        {% endif %}
        
        <div class="password-requirements">
          <p><strong>Password must contain:</strong></p>
          <ul id="requirements">
            <li id="req-length">At least 8 characters</li>
            <li id="req-uppercase">One uppercase letter</li>
            <li id="req-lowercase">One lowercase letter</li>
            <li id="req-number">One number</li>
            <li id="req-special">One special character (@$!%*?&)</li>
          </ul>
        </div>
      </div>
      
      <div class="form-group">
        <label for="password_confirmacion">Confirm New Password</label>
        <div class="password-input-wrapper">
          <input 
            type="password" 
            id="password_confirmacion" 
            name="password_confirmacion"
            placeholder="Confirm new password"
            required
            minlength="8"
          >
          <button type="button" class="toggle-password" onclick="togglePassword('password_confirmacion')">
            üëÅÔ∏è
          </button>
        </div>
        {% if form.password_confirmacion.errors %}
          <span class="error-message">{{ form.password_confirmacion.errors.0 }}</span>
        {% endif %}
        <span class="match-message" id="matchMessage"></span>
      </div>
      
      <button type="submit" class="auth-btn" id="submitBtn">Change Password</button>
    </form>

    <div class="security-tip">
      <span class="tip-icon">üí°</span>
      <div>
        <strong>Security Tip:</strong> Choose a strong password that you don't use for other accounts. Consider using a password manager.
      </div>
    </div>

  </div>
</div>

<script>
  function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    
    if (field.type === 'password') {
      field.type = 'text';
      button.textContent = 'üôà';
    } else {
      field.type = 'password';
      button.textContent = 'üëÅÔ∏è';
    }
  }

  // Validaci√≥n en tiempo real
  const passwordInput = document.getElementById('password_nueva');
  const confirmInput = document.getElementById('password_confirmacion');
  const matchMessage = document.getElementById('matchMessage');
  const submitBtn = document.getElementById('submitBtn');

  const requirements = {
    length: /^.{8,}$/,
    uppercase: /[A-Z]/,
    lowercase: /[a-z]/,
    number: /\d/,
    special: /[@$!%*?&]/
  };

  passwordInput.addEventListener('input', function() {
    const password = this.value;
    
    // Validar cada requisito
    document.getElementById('req-length').className = requirements.length.test(password) ? 'valid' : '';
    document.getElementById('req-uppercase').className = requirements.uppercase.test(password) ? 'valid' : '';
    document.getElementById('req-lowercase').className = requirements.lowercase.test(password) ? 'valid' : '';
    document.getElementById('req-number').className = requirements.number.test(password) ? 'valid' : '';
    document.getElementById('req-special').className = requirements.special.test(password) ? 'valid' : '';
    
    checkPasswordMatch();
  });

  confirmInput.addEventListener('input', checkPasswordMatch);

  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirm = confirmInput.value;
    
    if (confirm.length === 0) {
      matchMessage.textContent = '';
      matchMessage.className = 'match-message';
      return;
    }
    
    if (password === confirm) {
      matchMessage.textContent = '‚úì Passwords match';
      matchMessage.className = 'match-message match';
    } else {
      matchMessage.textContent = '‚úó Passwords do not match';
      matchMessage.className = 'match-message no-match';
    }
  }

  // Validar antes de enviar
  document.getElementById('passwordForm').addEventListener('submit', function(e) {
    const password = passwordInput.value;
    const confirm = confirmInput.value;
    
    if (password !== confirm) {
      e.preventDefault();
      alert('Passwords do not match!');
      return false;
    }
    
    // Validar requisitos
    for (let key in requirements) {
      if (!requirements[key].test(password)) {
        e.preventDefault();
        alert('Password does not meet all requirements!');
        return false;
      }
    }
  });
</script>
{% endblock %}