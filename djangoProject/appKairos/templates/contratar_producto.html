{% extends 'base.html' %}
{% load static %}

{% block title %}Contract Product - Proyecto Kairos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/contratar.css' %}">
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<nav class="breadcrumb">
  <a href="{% url 'appKairos:dashboard' %}">Dashboard</a> 
  <span>‚Ä∫</span>
  <span class="current">Contract Product</span>
</nav>

<!-- Main Content -->
<main class="contratar-main">
  
  <div class="contratar-container">
    
    <div class="back-link">
      <a href="{% url 'appKairos:dashboard' %}">‚Üê Back to Dashboard</a>
      </div>

    <h1>Contract Financial Product</h1>
    
    <div class="contratar-grid">
      
      <!-- Product Information -->
      <section class="product-info-section">
        <div class="product-header">
          <h2>{{ producto.nombre }}</h2>
          <span class="product-badge">{{ producto.codigo }}</span>
        </div>
        
        <div class="product-description">
          <p>{{ producto.descripcion }}</p>
        </div>

        <div class="product-details">
          <h3>Markets</h3>
          <div class="markets-list">
            {% for mercado in producto.mercados.all %}
              <span class="market-badge">{{ mercado.codigo }}</span>
            {% endfor %}
          </div>
        </div>

        <div class="product-stats">
          <div class="stat-item">
            <span class="stat-icon">üìä</span>
            <div>
              <p class="stat-label">Status</p>
              <p class="stat-value">{{ producto.activo|yesno:"Active,Inactive" }}</p>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">üìÖ</span>
            <div>
              <p class="stat-label">Created</p>
              <p class="stat-value">{{ producto.fecha_creacion|date:"M d, Y" }}</p>
            </div>
          </div>
        </div>

        <div class="risk-warning">
          <span class="warning-icon">‚ö†Ô∏è</span>
          <div>
            <strong>Risk Warning:</strong> Trading financial products involves significant risk. You may lose all your invested capital. Only invest money you can afford to lose.
          </div>
        </div>

      </section>

      <!-- Contract Form -->
      <section class="contract-form-section">
        <div class="form-header">
          <h2>Investment Details</h2>
          <span class="form-icon">üí∞</span>
        </div>
        
        <form method="POST" class="contratar-form" id="contractForm">
          {% csrf_token %}
          
          <input type="hidden" name="producto" value="{{ producto.id }}">

          <div class="form-group">
            <label for="monto_invertido">Investment Amount (‚Ç¨)</label>
            <div class="amount-input-wrapper">
              <span class="currency-symbol">‚Ç¨</span>
              <input 
                type="number" 
                id="monto_invertido" 
                name="monto_invertido"
                min="100"
                step="0.01"
                placeholder="1000.00"
                required
              >
            </div>
            <span class="help-text">Minimum investment: ‚Ç¨ 100.00</span>
            {% if form.monto_invertido.errors %}
              <span class="error-message">{{ form.monto_invertido.errors.0 }}</span>
            {% endif %}
          </div>

          <div class="investment-summary">
            <h3>Investment Summary</h3>
            <div class="summary-row">
              <span>Product:</span>
              <span class="summary-value">{{ producto.nombre }}</span>
            </div>
            <div class="summary-row">
              <span>Investment Amount:</span>
              <span class="summary-value" id="summaryAmount">‚Ç¨ 0.00</span>
            </div>
            <div class="summary-row total">
              <span>Total:</span>
              <span class="summary-value" id="summaryTotal">‚Ç¨ 0.00</span>
            </div>
          </div>

          <div class="form-check">
            <input 
              type="checkbox" 
              id="acepto_riesgos" 
              name="acepto_riesgos" 
              required
            >
            <label for="acepto_riesgos">
              I understand and accept the investment risks. I have read and agree to the <a href="#" target="_blank">terms and conditions</a>.
            </label>
          </div>

          <div class="form-actions">
            <button type="button" onclick="window.history.back()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary" id="submitBtn">Contract Product</button>
          </div>

        </form>

      </section>

    </div>

  </div>

</main>

<script>
  // Actualizar resumen en tiempo real
  const montoInput = document.getElementById('monto_invertido');
  const summaryAmount = document.getElementById('summaryAmount');
  const summaryTotal = document.getElementById('summaryTotal');
  const submitBtn = document.getElementById('submitBtn');

  montoInput.addEventListener('input', function() {
    const amount = parseFloat(this.value) || 0;
    const formattedAmount = amount.toLocaleString('es-ES', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    
    summaryAmount.textContent = `‚Ç¨ ${formattedAmount}`;
    summaryTotal.textContent = `‚Ç¨ ${formattedAmount}`;

    // Validar monto m√≠nimo
    if (amount < 100 && amount > 0) {
      this.setCustomValidity('Minimum investment is ‚Ç¨ 100.00');
      submitBtn.disabled = true;
    } else {
      this.setCustomValidity('');
      submitBtn.disabled = false;
    }
  });

  // Validar formulario antes de enviar
  document.getElementById('contractForm').addEventListener('submit', function(e) {
    const amount = parseFloat(montoInput.value);
    const acceptRisks = document.getElementById('acepto_riesgos').checked;

    if (amount < 100) {
      e.preventDefault();
      alert('Minimum investment amount is ‚Ç¨ 100.00');
      return false;
    }

    if (!acceptRisks) {
      e.preventDefault();
      alert('You must accept the investment risks to continue.');
      return false;
    }

    // Confirmar antes de enviar
    if (!confirm(`Are you sure you want to invest ‚Ç¨ ${amount.toFixed(2)} in ${producto.nombre}?`)) {
      e.preventDefault();
      return false;
    }
  });

  // Formato de moneda al salir del input
  montoInput.addEventListener('blur', function() {
    if (this.value) {
      const amount = parseFloat(this.value);
      this.value = amount.toFixed(2);
    }
  });
</script>
{% endblock %}